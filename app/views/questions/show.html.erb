<h1><%= @question.body %></h1>
<p><strong>Asked by:</strong> <%= @question.user.name %></p>
<hr>

<% if user_signed_in? %>
  <h2>Your Answer</h2>
  <%= form_with model: [@question, Answer.new], local: true do |form| %>
    <div>
      <%= form.label :body, "Write your answer" %>
    </div>
    <br>
    <div>
      <%= form.text_area :body, rows: 5, required: true %>
    </div>
    <br>
    <div>
      <%= form.submit "Post Answer" %>
    </div>
  <% end %>
<% else %>
  <p><%= button_to "Log in", new_user_session_path, class: "vote-button" %> or <%= button_to "Sign up", new_user_registration_path, class: "vote-button" %> to post an answer.</p>
<% end %>

<h2>Answers</h2>
<% if @question.answers.any? %>
  <% @question.answers.each do |answer| %>
    <div>
      <p><%= answer.body %></p>
        <% if user_signed_in? %>
            <% vote = answer.votes.find_by(user: current_user) %>
            <% if vote&.value == 1 %>
              <%= button_to "Unvote", unvote_question_answer_path(@question, answer), method: :delete, class: "vote-button" %>
            <% else %>
              <%= button_to "Upvote", upvote_question_answer_path(@question, answer), method: :post, class: "vote-button" %>
            <% end %>
            <% if vote&.value == -1 %>
              <%= button_to "Unvote", unvote_question_answer_path(@question, answer), method: :delete, class: "vote-button" %>
            <% else %>
              <%= button_to "Downvote", downvote_question_answer_path(@question, answer), method: :post, class: "vote-button" %>
            <% end %>
        <% end %>
        <span class="vote-count"><%= answer.votes.sum(:value) %> votes</span>
      <p><small><strong>Answered by:</strong> <%= answer.user.name %></small></p>
      <% if answer.user == current_user %>
        <div>
          <%= link_to "Edit", edit_question_answer_path(@question, answer) %>
          <%= button_to "Delete", question_answer_path(@question, answer), method: :delete, onclick: "return confirm('Are you sure you want to delete this Answer?');" %>
        </div>
      <% end %>
      <h3>Comments</h3>
      <div style="margin-left: 20px;">
        <% if answer.comments.any? %>
          <% answer.comments.each do |comment| %>
            <div style="margin-bottom: 10px;">
              <p><%= comment.body %></p>
              <p><small><strong>Commented by:</strong> <%= comment.user.name %></small></p>
              <% if comment.user == current_user %>
                <%= link_to "Edit", edit_question_answer_comment_path(@question, answer, comment) %>
                <%= button_to "Delete", question_answer_comment_path(@question, answer, comment), method: :delete, onclick: "return confirm('Are you sure you want to delete this Comment?');" %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p>No comments yet. Be the first to comment!</p>
        <% end %>
      </div>
      
      <% if user_signed_in? %>
        <h4>Add a Comment</h4>
        <%= form_with model: [@question, answer, Comment.new], local: true do |form| %>
        
          <div>
            <%= form.label :body, "Add your comment" %>
            <%= form.text_field :body, required: true %>
          </div>
          <div>
            <%= form.submit "Post Comment" %>
          </div>
        <% end %>
      <% else %>
        <p><%= link_to "Log in", new_user_session_path %> or <%= link_to "Sign up", new_user_registration_path %> to comment.</p>
      <% end %>
    </div>
    <hr>
  <% end %>
<% else %>
  <p>No answers yet. Be the first to answer!</p>
<% end %>
